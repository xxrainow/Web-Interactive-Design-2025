<!DOCTYPE html>
<html lang="ko">
  <head>
    <script>
      (function (d) {
        var config = {
            kitId: 'wxq3dyk',
            scriptTimeout: 3000,
            async: true,
          },
          h = d.documentElement,
          t = setTimeout(function () {
            h.className =
              h.className.replace(/\bwf-loading\b/g, '') + ' wf-inactive';
          }, config.scriptTimeout),
          tk = d.createElement('script'),
          f = false,
          s = d.getElementsByTagName('script')[0],
          a;
        h.className += ' wf-loading';
        tk.src = 'https://use.typekit.net/' + config.kitId + '.js';
        tk.async = true;
        tk.onload = tk.onreadystatechange = function () {
          a = this.readyState;
          if (f || (a && a != 'complete' && a != 'loaded')) return;
          f = true;
          clearTimeout(t);
          try {
            Typekit.load(config);
          } catch (e) {}
        };
        s.parentNode.insertBefore(tk, s);
      })(document);
    </script>
    <!-- html2canvas (DOM ìº¡ì³ìš©) -->
    <script
      src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"
      defer
    ></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¼€ì´í¬</title>
    <style>
      :root {
        /* ì–´ë””ì„œë¶€í„° ë…¸ë‘ìœ¼ë¡œ ë°”ê¿€ì§€ (ì˜ˆ: 70vh ì§€ì ) */
        --split-at: 75vh;
        /* ì›í•˜ëŠ” ë…¸ë‘ìƒ‰ */
        --bottom-color: #fff5b8;
      }

      body {
        background: linear-gradient(
            to bottom,
            transparent 0 var(--split-at),
            var(--bottom-color) var(--split-at) 100%
          ),
          #fff7f9; /* ê¸°ì¡´ ìœ„ìª½ ìƒ‰ */
        background-repeat: no-repeat;
        background-attachment: fixed, fixed;
        height: 100vh;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: 'timeline-210', sans-serif;
      }

      /* í˜ì´ì§€ ë¡œë“œì‹œ í˜ì´ë“œì¸ìš© ì˜¤ë²„ë ˆì´ */
      #pageFade {
        position: fixed;
        inset: 0;
        background: #fff7f9; /* ì´ˆê¸° ë°°ê²½ìƒ‰ê³¼ ë™ì¼í•˜ê²Œ */
        z-index: 9999;
        pointer-events: none; /* ì¸í„°ë™ì…˜ ë°©í•´ X */
        opacity: 1; /* ì²˜ìŒì—” ê°€ë“ ë®ì—¬ ìˆìŒ */
        transition: opacity 1000ms ease;
      }
      /* ì‚¬ë¼ì§ˆ ë•Œ */
      #pageFade.fade-out {
        opacity: 0;
      }

      /* ëª¨ì…˜ ìµœì†Œí™” í™˜ê²½ ëŒ€ì‘ */
      @media (prefers-reduced-motion: reduce) {
        #pageFade {
          transition: none;
          opacity: 0;
        }
      }

      /* ê³µí†µ */
      img {
        user-select: none;
      }
      /* ì¼€ì´í¬ */
      #cake {
        position: absolute;
        bottom: 110px;
        left: 50%;
        transform: translateX(-50%);
        width: 800px;
      }
      /* ì´ˆì— ë¶™ëŠ” ë¶ˆ (ì´ˆ ë¶ˆê½ƒ) */
      #candle-flame {
        position: absolute;
        left: 50%;
        --fx: -125px; /* X: ì™¼ìª½(-), ì˜¤ë¥¸ìª½(+) */
        --fy: -60px; /* Y: ìœ„(-), ì•„ë˜(+) */
        transform: translate(var(--fx), var(--fy));
        width: 40px;
        display: none;
        pointer-events: none;
      }
      /* ì„±ëƒ¥ê³½ (ê³ ì •) */
      #matchbox-hand {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 400px;
      }
      /* ì„±ëƒ¥ (ë“œë˜ê·¸ ê°€ëŠ¥) */
      #match-hand {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 600px;
        cursor: grab;
      }
      /* ì„±ëƒ¥ ë¶ˆ */
      #flame {
        position: absolute;
        width: 30px;
        left: 400px;
        display: none;
        pointer-events: none;

        --fx: -50px; /* X: ì™¼ìª½(-), ì˜¤ë¥¸ìª½(+) */
        --fy: 12px; /* Y: ìœ„(-), ì•„ë˜(+) */
        transform: translate(var(--fx), var(--fy));
      }

      /* ì•ˆë‚´ ë¬¸êµ¬ */
      #hint {
        position: absolute;
        top: 40px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 22px;
        color: #ff6f91;
        background: #fff;
        padding: 16px 50px;
        border-radius: 10px;
        border: 1px solid rgba(255, 111, 145, 1);
        box-shadow: 2px 3px 0px rgba(255, 111, 145, 1);
      }

      /* ë¶ˆê½ƒ ê³µí†µ: ê¸°ì¤€ ì˜¤í”„ì…‹ + í”ë“¤ë¦¼ + ìŠ¤ì¼€ì¼ì„ í•©ì„± */
      #flame,
      #candle-flame {
        /* ê¸°ì¡´ ë³´ì •(ì´ë¯¸ #flameì— --fx/--fy ìˆìŒ) + ì¶”ê°€ ë³´ì •(--tx/--ty) */
        --tx: 0px; /* candle-flameìš© ìœ„ì¹˜ ë¯¸ì„¸ ë³´ì • */
        --ty: 0px;

        /* í”ë“¤ë¦¼/ìŠ¤ì¼€ì¼ ë³€ìˆ˜ */
        --jx: 0px;
        --jy: 0px;
        --s: 1;

        /* í•©ì„±: ê¸°ì¡´ translate â†’ ì¶”ê°€ë³´ì • â†’ í”ë“¤ë¦¼ â†’ ìŠ¤ì¼€ì¼ */
        transform: translate(var(--fx, 0px), var(--fy, 0px))
          translate(var(--tx), var(--ty)) translate(var(--jx), var(--jy))
          scale(var(--s));
        transform-origin: 50% 80%;
        filter: drop-shadow(0 0 8px rgba(255, 160, 0, 0.55));
        will-change: transform, filter; /* ë¶€ë“œëŸ½ê²Œ */
      }

      /* ì í™” ì‹œ ë¶™ì¼ í´ë˜ìŠ¤ */
      .flicker {
        animation: flame-flicker 100ms infinite alternate ease-in-out;
      }

      /* ëª¨ì…˜ ì„ í˜¸ êº¼ì§ ëŒ€ì‘ */
      @media (prefers-reduced-motion: reduce) {
        .flicker {
          animation: none;
        }
      }

      /* í‚¤í”„ë ˆì„: ìŠ¤ì¼€ì¼ + ì‚´ì§ í”ë“¤ë¦¼ + ê¸€ë¡œìš° ê°•ì•½ */
      @keyframes flame-flicker {
        0% {
          --s: 0.9;
          --jx: -1px;
          --jy: 0px;
          filter: drop-shadow(0 0 6px rgba(255, 180, 0, 0.45));
        }
        100% {
          --s: 1.15;
          --jx: 1px;
          --jy: -0.9px;
          filter: drop-shadow(0 0 12px rgba(255, 200, 0, 0.7));
        }
      }

      /* ë°°ê²½ì„ ëŒ€ê°ì„ ìœ¼ë¡œ íë¥´ê²Œ í•˜ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
      @keyframes bg-shift {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      /* ë¬´ì§€ê°œì²˜ëŸ¼ ìƒ‰ìƒì´ ê³„ì† ë³€í•˜ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
      @keyframes rainbow-cycle {
        0% {
          filter: hue-rotate(0deg);
        }
        100% {
          filter: hue-rotate(360deg);
        }
      }

      /* 1ì´ˆì— í•œ ë²ˆì”© ë°ê²Œ ê¹œë¹¡ì´ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
      @keyframes blink-effect {
        0%,
        100% {
          filter: brightness(1);
        }
        50% {
          filter: brightness(1.6);
        } /* ë” ë°ê²Œ ê¹œë¹¡ì´ë„ë¡ ìˆ˜ì¹˜ ì¡°ì • */
      }

      /* 'HAPPY BIRTHDAY' í…ìŠ¤íŠ¸ íë¦„ ì• ë‹ˆë©”ì´ì…˜ */
      @keyframes text-scroll {
        from {
          transform: translateX(0);
        }
        to {
          transform: translateX(-50%);
        } /* í…ìŠ¤íŠ¸ë¥¼ 2ë²ˆ ë°˜ë³µí•˜ì—¬ ëŠê¹€ ì—†ëŠ” íš¨ê³¼ */
      }

      /* ì´›ë¶ˆì´ ì¼œì¡Œì„ ë•Œ bodyì— ì ìš©ë  í´ë˜ìŠ¤ */
      body.celebrate {
        --scroll-text: 'â‹°Ëšâ˜… HAPPY BIRTHDAY â›§*Ì©Ì©Í™â¸â‹† HAPPY BIRTHDAY â˜…!Â¡ HAPPY BIRTHDAY â‹°Ëšâœ© HAPPY BIRTHDAY âœ©â¡±';
        /* ë” í™”ë ¤í•˜ê³  ë‹¤ì±„ë¡œìš´ ê·¸ë¼ë°ì´ì…˜ ìƒ‰ìƒ */
        background: linear-gradient(
            120deg,
            rgba(255, 121, 198, 0.95),
            rgba(189, 147, 249, 0.95),
            rgba(255, 184, 108, 0.95),
            rgba(80, 250, 123, 0.95),
            rgba(139, 233, 253, 0.95),
            rgba(255, 85, 85, 0.95),
            rgba(241, 250, 140, 0.95)
          ),
          linear-gradient(
            to bottom,
            transparent 0 var(--split-at),
            var(--bottom-color) var(--split-at) 100%
          ),
          #fff7f9;
        /* ê·¸ë¼ë°ì´ì…˜ì´ ë¶€ë“œëŸ½ê²Œ ì›€ì§ì´ë„ë¡ í¬ê¸°ë¥¼ í¬ê²Œ ì„¤ì • */
        background-size: 400% 400%, 100% 100%, 100% 100%;
        background-position: 0% 50%, 0 0, 0 0;
        background-repeat: no-repeat, no-repeat, no-repeat;
        background-blend-mode: hard-light, normal, normal; /* â† ì—¬ê¸°! */

        /* 3ê°€ì§€ ì• ë‹ˆë©”ì´ì…˜ì„ ë™ì‹œì— ì ìš© */
        animation: bg-shift 15s ease infinite,
          /* ë°°ê²½ íë¦„ */ rainbow-cycle 6s linear infinite,
          /* ìƒ‰ìƒ ë³€í™” */ blink-effect 1s ease-in-out infinite; /* 1ì´ˆ ê¹œë¹¡ì„ */
      }

      /* íë¥´ëŠ” í…ìŠ¤íŠ¸ë¥¼ ìœ„í•œ ê°€ìƒ ìš”ì†Œ */
      body.celebrate::before {
        content: var(--scroll-text);
        font-family: 'timeline-210', sans-serif;
        position: absolute;
        top: 14%;
        left: 0;
        transform: translateY(-50%);
        width: 400%; /* ëŠê¹€ ì—†ëŠ” ìŠ¤í¬ë¡¤ì„ ìœ„í•´ 2ë°° ë„ˆë¹„ */
        color: rgb(255, 67, 120);
        font-size: 8vw; /* í™”ë©´ í¬ê¸°ì— ë°˜ì‘í•˜ëŠ” í°íŠ¸ */
        font-weight: 800;
        text-transform: uppercase;
        white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
        z-index: -1; /* ë‹¤ë¥¸ ì½˜í…ì¸  ë’¤ë¡œ ë³´ë‚´ê¸° */
        animation: text-scroll 5s linear infinite;
      }

      /* ëª¨ì…˜ ìµœì†Œí™” í™˜ê²½ì—ì„œëŠ” ê¹œë¹¡ì„ê³¼ ìƒ‰ìƒ ë³€í™”ë¥¼ ì œê±° */
      @media (prefers-reduced-motion: reduce) {
        body.celebrate {
          /* ë¶€ë“œëŸ¬ìš´ ë°°ê²½ íë¦„ë§Œ ìœ ì§€ */
          animation: bg-shift 15s ease infinite;
        }
      }

      .wishlist-toggle {
        position: fixed;
        right: 40px;
        bottom: 160px;
        z-index: 10000;
        padding: 15px 30px;
        border: none;
        border-radius: 999px;
        background: #ff4d6d;
        color: #fff;
        font-size: 18px;
        font-family: 'timeline-210', sans-serif;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .wishlist-toggle:hover {
        filter: brightness(1.08);
      }

      .wishlist-panel {
        position: fixed;
        right: 40px;
        bottom: 215px; /* í† ê¸€ ë²„íŠ¼ ìœ„ë¡œ */
        width: 320px;
        max-height: 60vh;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 14px;
        border-radius: 16px;
        background: #fff;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.18);
        z-index: 10001;

        /* ê¸°ë³¸ì€ ë‹«í˜ ìƒíƒœ (íˆ¬ëª… + ì•½ê°„ ì•„ë˜ + scale) */
        opacity: 0;
        transform: translateY(12px) scale(0.98);
        pointer-events: none;
        transition: opacity 0.22s ease, transform 0.22s ease;
        font-family: 'timeline-210', sans-serif;
      }
      .wishlist-panel.open {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
      }

      .wl-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .wl-header strong {
        font-size: 1.05rem;
        color: #333;
      }
      .wl-close {
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 1.05rem;
        line-height: 1;
        color: #888;
      }
      .wl-close:hover {
        color: #111;
      }

      .wl-form {
        display: flex;
        gap: 8px;
      }
      .wl-input {
        flex: 1;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #e7e7e7;
        font-size: 0.95rem;
      }
      .wl-add {
        padding: 10px 12px;
        border: none;
        border-radius: 10px;
        background: #ff80a4;
        color: #fff;
        cursor: pointer;
      }
      .wl-add:hover {
        filter: brightness(1.05);
      }

      .wishlist-list {
        list-style: none;
        margin: 0;
        padding: 0;
        overflow: auto; /* ìŠ¤í¬ë¡¤ */
      }
      .wishlist-list li {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 6px;
        border-bottom: 1px dashed #eee;
      }
      .wishlist-list .wl-text {
        flex: 1;
        word-break: break-word;
      }
      .wishlist-list .wl-del {
        border: none;
        background: transparent;
        cursor: pointer;
        color: #999;
        font-size: 0.95rem;
      }
      .wishlist-list .wl-del:hover {
        color: #ff4d6d;
      }

      .wl-footer {
        display: flex;
        justify-content: flex-end;
      }
      .wl-clear {
        border: none;
        background: transparent;
        cursor: pointer;
        color: #888;
        font-size: 0.9rem;
        text-decoration: underline;
      }
      .wl-clear:hover {
        color: #333;
      }

      /* ===== ğŸ’Œ Letter panel ===== */
      .letter-toggle {
        position: fixed;
        right: 40px;
        bottom: 100px; /* ìœ„ì‹œ í† ê¸€(20px) ìœ„ë¡œ ì‚´ì§ ë„ì›€ */
        z-index: 10000;
        padding: 15px 30px;
        border: none;
        border-radius: 999px;
        background: #ff4d6d;
        color: #fff;
        font-size: 18px;
        font-family: 'timeline-210', sans-serif;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .letter-toggle:hover {
        filter: brightness(1.08);
      }

      .letter-panel {
        position: fixed;
        right: 40px;
        bottom: 155px; /* í† ê¸€ ë²„íŠ¼ ìœ„ë¡œ */
        width: 340px;
        max-height: 65vh;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 14px;
        border-radius: 16px;
        background: #fff;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.18);
        z-index: 10001;

        opacity: 0;
        transform: translateY(12px) scale(0.98);
        pointer-events: none;
        transition: opacity 0.22s ease, transform 0.22s ease;
        font-family: 'timeline-210', sans-serif;
      }
      .letter-panel.open {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
      }

      .lt-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .lt-header strong {
        font-size: 1.05rem;
        color: #333;
      }
      .lt-close {
        border: none;
        background: transparent;
        cursor: pointer;
        color: #888;
        font-size: 1.05rem;
      }
      .lt-close:hover {
        color: #111;
      }

      .lt-input {
        width: 92%;
        min-height: 220px;
        resize: vertical;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #e7e7e7;
        font-size: 0.95rem;
        line-height: 1.5;
        outline: none;
      }
      .lt-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: space-between;
      }
      .lt-left {
        display: flex;
        gap: 8px;
      }
      .lt-btn {
        padding: 10px 12px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        background: #ff80a4;
        color: #fff;
      }
      .lt-btn.secondary {
        background: #f1f3f5;
        color: #333;
      }
      .lt-btn:hover {
        filter: brightness(1.05);
      }

      .lt-meta {
        font-size: 0.85rem;
        color: #777;
        margin-left: auto;
      }

      /* ===== ì˜¤ëŠ˜ì„ ê¸°ì–µí•˜ê¸° (ìŠ¤í¬ë¦°ìƒ·) ===== */
      .memory-toggle {
        position: fixed;
        right: 40px;
        bottom: 40px; /* 'ë‚˜ì—ê²Œ í¸ì§€ ì“°ê¸°' ë²„íŠ¼(40px)ë³´ë‹¤ ë” ì•„ë˜ */
        z-index: 10000;
        padding: 15px 30px;
        border: none;
        border-radius: 999px;
        background: #ff4d6d;
        color: #fff;
        font-size: 18px;
        font-family: 'timeline-210', sans-serif;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .memory-toggle:hover {
        filter: brightness(1.08);
      }

      .memory-panel {
        position: fixed;
        right: 40px;
        bottom: 95px;
        width: 340px;
        max-height: 60vh;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 14px;
        border-radius: 16px;
        background: #fff;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.18);
        z-index: 10001;
        opacity: 0;
        transform: translateY(12px) scale(0.98);
        pointer-events: none;
        transition: opacity 0.22s ease, transform 0.22s ease;
        font-family: 'timeline-210', sans-serif;
      }
      .memory-panel.open {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
      }

      .mem-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .mem-header strong {
        font-size: 1.05rem;
        color: #333;
      }
      .mem-close {
        border: none;
        background: transparent;
        cursor: pointer;
        color: #888;
        font-size: 1.05rem;
      }
      .mem-close:hover {
        color: #111;
      }

      .mem-actions {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .mem-btn {
        padding: 10px 12px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        background: #ff80a4;
        color: #fff;
      }
      .mem-btn:hover {
        filter: brightness(1.05);
      }
      .mem-note {
        font-size: 0.85rem;
        color: #777;
        line-height: 1.4;
      }
      .mem-meta {
        font-size: 0.85rem;
        color: #777;
      }

      /* ìº¡ì³ ì§ì „ ì¼ì‹œ ìˆ¨ê¹€ì— ì‚¬ìš© */
      .capture-hide {
        visibility: hidden !important;
      }

      /* =====  BGM í† ê¸€ ë²„íŠ¼ ===== */
      .bgm-toggle {
        position: fixed;
        right: 20px;
        top: 30px;
        z-index: 99;
        padding: 10px 14px;
        border: none;
        border-radius: 999px;
        background: #222;
        color: #fff;
        font-size: 0.95rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        font-family: 'timeline-210', sans-serif;
      }
      .bgm-toggle:hover {
        filter: brightness(1.1);
      }
    </style>
  </head>
  <body>
    <div id="pageFade" aria-hidden="true"></div>

    <div>
      <div id="hint">ì„±ëƒ¥ì„ ì„±ëƒ¥ê³½ ìª½ìœ¼ë¡œ ë¬¸ì§ˆëŸ¬ ë³´ì„¸ìš” ğŸ”¥</div>
      <img draggable="false" id="cake" src="images/cake.png" alt="ì¼€ì´í¬" />
      <img
        draggable="false"
        id="matchbox-hand"
        src="images/matchbox.png"
        alt="ì„±ëƒ¥ê³½ì„ ë“  ì†"
      />
      <!-- ì¼€ì´í¬ ìœ„ ì´ˆ ë¶ˆ ì´ë¯¸ì§€ -->
      <img
        draggable="false"
        id="candle-flame"
        src="images/flame.png"
        alt="ì´ˆ ë¶ˆê½ƒ"
      />
      <img
        draggable="false"
        id="match-hand"
        src="images/match.png"
        alt="ì„±ëƒ¥ì„ ë“  ì†"
      />
      <img draggable="false" id="flame" src="images/flame.png" alt="ë¶ˆê½ƒ" />

      <!--  ë°°ê²½ ìŒì•… -->
      <audio id="birthdaybgm" preload="auto" loop>
        <source src="bgm/birthdaybgm.wav" type="audio/wav" />
      </audio>
      <audio id="firebgm" preload="auto">
        <source src="bgm/fire.mp3" type="audio/mp3" />
      </audio>
      <audio id="firingbgm" preload="auto" loop>
        <source src="bgm/firing.mp3" type="audio/mp3" />
      </audio>

      <button
        id="wishlist-toggle"
        class="wishlist-toggle"
        aria-haspopup="dialog"
        aria-expanded="false"
        aria-controls="wishlist-panel"
      >
        ìœ„ì‹œë¦¬ìŠ¤íŠ¸
      </button>

      <!-- ìœ„ì‹œë¦¬ìŠ¤íŠ¸ íŒ¨ë„ -->
      <div
        id="wishlist-panel"
        class="wishlist-panel"
        role="dialog"
        aria-modal="false"
        aria-labelledby="wishlist-title"
      >
        <div class="wl-header">
          <strong id="wishlist-title">ìœ„ì‹œë¦¬ìŠ¤íŠ¸</strong>
          <button type="button" class="wl-close" aria-label="ë‹«ê¸°">âœ•</button>
        </div>

        <form id="wishlist-form" class="wl-form" autocomplete="off">
          <input
            id="wishlist-input"
            class="wl-input"
            type="text"
            placeholder="ì›í•˜ëŠ” ê±¸ ì ì–´ë³´ì„¸ìš” (Enter)"
          />
          <button type="submit" class="wl-add">ì¶”ê°€</button>
        </form>

        <ul id="wishlist-list" class="wishlist-list" aria-live="polite"></ul>

        <div class="wl-footer">
          <button id="wishlist-clear" type="button" class="wl-clear">
            ì „ì²´ ì‚­ì œ
          </button>
        </div>
      </div>

      <!-- í¸ì§€ í† ê¸€ ë²„íŠ¼ -->
      <button
        id="letter-toggle"
        class="letter-toggle"
        aria-haspopup="dialog"
        aria-expanded="false"
        aria-controls="letter-panel"
      >
        ë‚˜ì—ê²Œ í¸ì§€ ì“°ê¸°
      </button>

      <!-- í¸ì§€ íŒ¨ë„ -->
      <div
        id="letter-panel"
        class="letter-panel"
        role="dialog"
        aria-modal="false"
        aria-labelledby="letter-title"
      >
        <div class="lt-header">
          <strong id="letter-title">ë‚˜ì—ê²Œ ì“°ëŠ” í¸ì§€</strong>
          <button type="button" class="lt-close" aria-label="ë‹«ê¸°">âœ•</button>
        </div>

        <textarea
          id="letter-textarea"
          class="lt-input"
          placeholder="ì˜¤ëŠ˜ì˜ í•˜ë£¨ë¥¼ ì ì–´ë³´ì„¸ìš”..."
        ></textarea>

        <div class="lt-actions">
          <div class="lt-left">
            <button id="letter-save" class="lt-btn" type="button">ì €ì¥</button>
            <button id="letter-download" class="lt-btn secondary" type="button">
              TXTë¡œ ë‹¤ìš´
            </button>
            <button id="letter-clear" class="lt-btn secondary" type="button">
              ì „ì²´ ì‚­ì œ
            </button>
          </div>
          <span id="letter-meta" class="lt-meta" aria-live="polite"></span>
        </div>
      </div>
      <!-- ì˜¤ëŠ˜ì„ ê¸°ì–µí•˜ê¸°: í† ê¸€ ë²„íŠ¼ -->
      <button
        id="memory-toggle"
        class="memory-toggle"
        aria-haspopup="dialog"
        aria-expanded="false"
        aria-controls="memory-panel"
      >
        ì˜¤ëŠ˜ì„ ê¸°ì–µí•˜ê¸°
      </button>

      <!-- ì˜¤ëŠ˜ì„ ê¸°ì–µí•˜ê¸°: íŒ¨ë„ -->
      <div
        id="memory-panel"
        class="memory-panel"
        role="dialog"
        aria-modal="false"
        aria-labelledby="memory-title"
      >
        <div class="mem-header">
          <strong id="memory-title">ì˜¤ëŠ˜ì„ ê¸°ì–µí•˜ê¸°</strong>
          <button type="button" class="mem-close" aria-label="ë‹«ê¸°">âœ•</button>
        </div>

        <div class="mem-actions">
          <button id="mem-capture" class="mem-btn" type="button">
            í™”ë©´ ìº¡ì³ (PNG)
          </button>
        </div>
        <p class="mem-note">TIP: íŒ¨ë„/ë²„íŠ¼ì€ ìº¡ì³ì—ì„œ ìë™ ì œì™¸ë¼ìš”.</p>
        <span id="mem-meta" class="mem-meta" aria-live="polite"></span>
      </div>

      <button
        id="bgm-toggle"
        class="bgm-toggle"
        aria-pressed="false"
        aria-label="ë°°ê²½ìŒì•… ì¼œê¸°/ë„ê¸°"
      >
        BGM ì¼œê¸°
      </button>
    </div>
    <script>
      // ëª¨ë“  ë¦¬ì†ŒìŠ¤(ì´ë¯¸ì§€ ë“±) ë‹¤ ë¡œë“œëœ ë’¤ í˜ì´ë“œì•„ì›ƒ
      function runPageFadeIn() {
        const overlay = document.getElementById('pageFade');
        if (!overlay) return;
        // ë‹¤ìŒ í”„ë ˆì„ì—ì„œ í´ë˜ìŠ¤ë¥¼ ë°”ê¿”ì•¼ ì „í™˜ì´ í™•ì‹¤íˆ ê±¸ë¦¼
        requestAnimationFrame(() => {
          overlay.classList.add('fade-out');
          overlay.addEventListener('transitionend', () => overlay.remove(), {
            once: true,
          });
        });
      }
      if (document.readyState === 'complete') {
        runPageFadeIn(); // ìºì‹œë¡œ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°
      } else {
        window.addEventListener('load', runPageFadeIn); // ì¼ë°˜ì ì¸ ê²½ìš°
      }

      const match = document.getElementById('match-hand');
      const matchbox = document.getElementById('matchbox-hand');
      const cake = document.getElementById('cake');
      const flame = document.getElementById('flame');
      const candleFlame = document.getElementById('candle-flame');
      const hint = document.getElementById('hint');

      let isDragging = false;
      let hasFire = false;
      let candleLit = false;
      // (ì˜¤ë¥˜ ë°©ì§€ìš©) ì˜¤ë””ì˜¤ í”„ë¼ì´ë° í”Œë˜ê·¸
      let birthdayBgmPrimed = false;

      // ë§ˆìš°ìŠ¤ ê¸°ì¤€ ì„±ëƒ¥ 'ë' ì¢Œí‘œ ë³´ì •ê°’(px)
      // flameì´ (e.pageX-40, e.pageY-120) + CSS translate(-50px, +12px)
      const TIP_DX = -90; // ì™¼(-) / ì˜¤(+)
      const TIP_DY = -108; // ìœ„(-) / ì•„ë˜(+)

      // ì„±ëƒ¥ê³½ ë‚´ë¶€ í•«ìŠ¤íŒŸ ë¹„ìœ¨ (x, y, w, h)
      const HOTSPOT = { x: 0.6, y: 0.35, w: 0.2, h: 0.15 };
      // ì¼€ì´í¬ ìœ„ ì´ˆ ìœ„ì¹˜ ë¹„ìœ¨ (x, y, w, h)
      const CANDLE_SPOTS = [
        { x: 0.5, y: 0, w: 0.3, h: 0.1 }, // ê°€ìš´ë° ì´ˆ ê·¼ì²˜(ì˜ˆì‹œê°’)
        // { x: 0.44, y: 0.18, w: 0.03, h: 0.06 }, // ì™¼ìª½ ì´ˆ (í•„ìš”ì‹œ)
        // { x: 0.56, y: 0.18, w: 0.03, h: 0.06 }, // ì˜¤ë¥¸ìª½ ì´ˆ (í•„ìš”ì‹œ)
      ];

      // í¬ì¸í„°(ë§ˆìš°ìŠ¤) ê¸°ì¤€ 'ì„±ëƒ¥ ë'ì˜ í™”ë©´ ì¢Œí‘œ
      function getMatchTipPoint(e) {
        return { x: e.pageX + TIP_DX, y: e.pageY + TIP_DY };
      }

      // ì„±ëƒ¥ê³½ ë‚´ë¶€ 'í•«ìŠ¤íŒŸ'ì˜ í™”ë©´ìƒ ì‚¬ê°í˜•(px)
      function getHotspotRect() {
        const r = matchbox.getBoundingClientRect();
        return {
          left: r.left + r.width * HOTSPOT.x,
          top: r.top + r.height * HOTSPOT.y,
          right: r.left + r.width * (HOTSPOT.x + HOTSPOT.w),
          bottom: r.top + r.height * (HOTSPOT.y + HOTSPOT.h),
        };
      }

      // ì¼€ì´í¬ ìœ„ ì´ˆ ìœ„ì¹˜ë“¤ì˜ í™”ë©´ìƒ ì‚¬ê°í˜•(px) ë°°ì—´
      function getCandleRects() {
        const r = cake.getBoundingClientRect();
        return CANDLE_SPOTS.map((s) => ({
          left: r.left + r.width * s.x,
          top: r.top + r.height * s.y,
          right: r.left + r.width * (s.x + s.w),
          bottom: r.top + r.height * (s.y + s.h),
        }));
      }

      // ê²¹ì¹¨ í™•ì¸ í•¨ìˆ˜
      function isOverlap(a, b) {
        const r1 = a.getBoundingClientRect();
        const r2 = b.getBoundingClientRect();
        return !(
          r1.right < r2.left ||
          r1.left > r2.right ||
          r1.bottom < r2.top ||
          r1.top > r2.bottom
        );
      }

      /* ============================
       * ë“œë˜ê·¸ & ì¸í„°ë™ì…˜
       * ============================ */

      match.addEventListener('mousedown', (e) => {
        isDragging = true;
        match.style.cursor = 'grabbing';

        // ì²« ì‚¬ìš©ì ì œìŠ¤ì²˜ì—ì„œ ì˜¤ë””ì˜¤ ë¯¸ë¦¬ í™œì„±í™”(ë¬´ìŒ ì¬ìƒ)
        if (!birthdayBgmPrimed) {
          try {
            birthdaybgm.volume = 0;
            birthdaybgm
              .play()
              .then(() => {
                birthdayBgmPrimed = true;
              })
              .catch(() => {
                /* ì •ì±…ìœ¼ë¡œ ë§‰íˆë©´ ë‚˜ì¤‘ì— ì¬ì‹œë„ */
              });
          } catch {}
        }
      });

      // ë“œë˜ê·¸ ì´ë™
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;

        // ì„±ëƒ¥ì´ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ë¥¼ ë”°ë¼ ì´ë™
        match.style.left = `${e.pageX - 80}px`;
        match.style.top = `${e.pageY - 60}px`;

        // ë¶ˆê½ƒì´ ì„±ëƒ¥ì— ë”°ë¼ ì´ë™
        flame.style.left = `${e.pageX - 40}px`;
        flame.style.top = `${e.pageY - 120}px`;

        if (!hasFire) checkIgnite(e);
        if (hasFire && !candleLit) checkCandleOverlap(e);
      });

      // ë“œë˜ê·¸ ì¢…ë£Œ
      document.addEventListener('mouseup', () => {
        isDragging = false;
        match.style.cursor = 'grab';
      });

      /* ============================
       * ì í™” ë¡œì§
       * ============================ */

      function checkIgnite(e) {
        const tip = getMatchTipPoint(e);
        const hs = getHotspotRect();
        const inside =
          tip.x >= hs.left &&
          tip.x <= hs.right &&
          tip.y >= hs.top &&
          tip.y <= hs.bottom;

        if (inside) ignite();
      }

      function ignite() {
        if (hasFire) return;
        hasFire = true;
        flame.style.display = 'block';
        flame.classList.add('flicker'); // â† ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        hint.textContent = 'ì„±ëƒ¥ì— ë¶ˆì´ ë¶™ì—ˆì–´ìš”! ì´ì œ ì´ˆì— ê°€ì ¸ê°€ì„¸ìš” ğŸ•¯ï¸';
      }

      // 2. ë¶ˆ ë¶™ì€ ì„±ëƒ¥ì´ ì¼€ì´í¬ sìœ„ ì´ˆ ê·¼ì²˜ë¡œ ê°€ë©´ ì´ˆì— ë¶ˆ ì¼œê¸°
      function checkCandleOverlap(e) {
        const tip = getMatchTipPoint(e);
        const spots = getCandleRects();

        for (const rect of spots) {
          const inside =
            tip.x >= rect.left &&
            tip.x <= rect.right &&
            tip.y >= rect.top &&
            tip.y <= rect.bottom;
          if (inside) {
            lightCandleAt(rect);
            break;
          }
        }

        try {
          firebgm.volume = 1; // ì›í•˜ëŠ” ë³¼ë¥¨
          firebgm.play().catch(() => {}); // ì •ì±…ìœ¼ë¡œ ë§‰íˆë©´ catch
          firingbgm.volume = 1;
          firingbgm.play().catch(() => {}); // ì •ì±…ìœ¼ë¡œ ë§‰íˆë©´ catch
        } catch {}
      }

      // ì´›ë¶ˆ ì´ë¯¸ì§€ ìœ„ì¹˜ë¥¼ í•«ìŠ¤íŒŸ ìœ„ë¡œ ì •ë ¬
      function lightCandleAt(rect) {
        if (candleLit) return;

        // í•«ìŠ¤íŒŸ ìƒë‹¨ ì¤‘ì•™ì— ë§ì¶”ì–´ ë°°ì¹˜
        const cx = (rect.left + rect.right) / 2;
        const cy = rect.top;

        candleFlame.style.display = 'block';
        candleFlame.style.left = `${cx}px`;
        candleFlame.style.top = `${cy}px`;

        // ì¤‘ì•™ ì •ë ¬/ë¯¸ì„¸ë³´ì •ì€ CSS ë³€ìˆ˜ë¡œ (transform ë®ì–´ì“°ì§€ ì•Šê¸°!)
        candleFlame.style.setProperty('--tx', '-15px');
        candleFlame.style.setProperty('--ty', '-2px');

        candleFlame.classList.add('flicker'); // â† ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘

        candleLit = true;
        hint.textContent = buildCongrats();
        document.body.classList.add('celebrate');
        // í˜ì´ë“œì¸ ì—†ì´ ì¦‰ì‹œ ì¬ìƒ
        try {
          birthdaybgm.volume = 0.6; // ì›í•˜ëŠ” ë³¼ë¥¨
          birthdaybgm.play().catch(() => {}); // ì •ì±…ìœ¼ë¡œ ë§‰íˆë©´ catch
          startbgm.pause();
          startbgm.currentTime = 0;
        } catch {}
      }

      /* ============================
       * URL íŒŒë¼ë¯¸í„° ì½ê¸° & ì¶•í•˜ ë¬¸êµ¬ ë§Œë“¤ê¸°
       * ============================ */
      // --- URL íŒŒë¼ë¯¸í„°(name, age) ì½ê¸° ---
      let userName = '';
      let userAge = '';

      (() => {
        const p = new URLSearchParams(window.location.search);
        const n = (p.get('name') || '').trim();
        const a = (p.get('age') || '').trim();
        const ageNum = parseInt(a, 10);
        if (n) userName = n;
        if (!Number.isNaN(ageNum) && ageNum > 0) userAge = String(ageNum);
      })();

      // --- ì¶•í•˜ ë¬¸êµ¬ ë§Œë“¤ê¸° ---
      function buildCongrats() {
        if (userName && userAge)
          return `${userName}ë‹˜ ${userAge}ë²ˆì§¸ ìƒì¼ì„ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰`;
        if (userName) return `${userName}ë‹˜, ìƒì¼ì„ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰`;
        if (userAge) return `${userAge}ë²ˆì§¸ ìƒì¼ì„ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰`;
        return 'ìƒì¼ì„ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰';
      }

      // ::before contentì— ë“¤ì–´ê°ˆ ìŠ¤í¬ë¡¤ ë¬¸êµ¬ ë§Œë“¤ê¸°
      (function () {
        const base =
          'â‹°Ëšâ˜… HAPPY BIRTHDAY â›§*Ì©Ì©Í™â¸â‹† HAPPY BIRTHDAY â˜…!Â¡ HAPPY BIRTHDAY â‹°Ëšâœ© HAPPY BIRTHDAY âœ©â¡±';

        const rawName = (userName ?? '').trim();
        // ì²« ê¸€ì ì œê±° (ë¬¸ì ë‹¨ìœ„: ì´ëª¨ì§€ ë“± í¬í•¨ ì•ˆì „)
        const nameTail = rawName ? Array.from(rawName).slice(1).join('') : '';
        const scroll = userName
          ? `HAPPY BIRTHDAY â‹°Ëšâ˜… ${nameTail}! ${userAge}ë²ˆì§¸ ìƒì¼ì„ ì§„ì‹¬ìœ¼ë¡œ ì¶•í•˜í•´! â›§*Ì©Ì©Í™â¸â‹† HAPPY BIRTHDAY â˜…!Â¡ HAPPY BIRTHDAY â‹°Ëšâœ© HAPPY BIRTHDAY âœ©â¡±`
          : base;

        // contentì— ì“°ì´ëŠ” CSS ë³€ìˆ˜ëŠ” ë°˜ë“œì‹œ â€œë”°ì˜´í‘œ í¬í•¨ëœ ë¬¸ìì—´â€ ë¡œ ë„£ì–´ì•¼ í•¨
        document.body.style.setProperty('--scroll-text', `"${scroll}"`);
      })();

      // ===== Wishlist logic =====
      (() => {
        const KEY = 'hb_wishlist_v1';

        const $toggle = document.getElementById('wishlist-toggle');
        const $panel = document.getElementById('wishlist-panel');
        const $form = document.getElementById('wishlist-form');
        const $input = document.getElementById('wishlist-input');
        const $list = document.getElementById('wishlist-list');
        const $clear = document.getElementById('wishlist-clear');
        const $close = $panel.querySelector('.wl-close');

        let items = [];

        function load() {
          try {
            const raw = localStorage.getItem(KEY);
            items = raw ? JSON.parse(raw) : [];
          } catch {
            items = [];
          }
          render();
        }
        function save() {
          try {
            localStorage.setItem(KEY, JSON.stringify(items));
          } catch {}
        }
        function render() {
          $list.innerHTML = '';
          if (!items.length) {
            const empty = document.createElement('li');
            empty.style.color = '#999';
            empty.textContent = 'ì•„ì§ í•­ëª©ì´ ì—†ì–´ìš”.';
            $list.appendChild(empty);
            return;
          }
          items.forEach((text, i) => {
            const li = document.createElement('li');
            const span = document.createElement('span');
            span.className = 'wl-text';
            span.textContent = text;

            const del = document.createElement('button');
            del.className = 'wl-del';
            del.type = 'button';
            del.setAttribute('aria-label', `ì‚­ì œ: ${text}`);
            del.textContent = 'ì‚­ì œ';

            del.addEventListener('click', (e) => {
              e.stopPropagation();
              items.splice(i, 1);
              save();
              render();
            });

            li.appendChild(span);
            li.appendChild(del);
            $list.appendChild(li);
          });
        }

        function openPanel() {
          $panel.classList.add('open');
          $toggle.setAttribute('aria-expanded', 'true');
          // ì—´ë¦´ ë•Œ ì…ë ¥ì°½ í¬ì»¤ìŠ¤
          setTimeout(() => $input.focus(), 60);
        }
        function closePanel() {
          $panel.classList.remove('open');
          $toggle.setAttribute('aria-expanded', 'false');
        }
        function togglePanel() {
          if ($panel.classList.contains('open')) closePanel();
          else openPanel();
        }

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        $toggle.addEventListener('click', (e) => {
          e.stopPropagation();
          togglePanel();
        });
        $close.addEventListener('click', (e) => {
          e.stopPropagation();
          closePanel();
        });

        // í¼ ì œì¶œ(ì¶”ê°€)
        $form.addEventListener('submit', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const text = $input.value.trim();
          if (!text) return;
          items.unshift(text);
          $input.value = '';
          save();
          render();
        });

        // ì „ì²´ ì‚­ì œ
        $clear.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!items.length) return;
          if (confirm('ëª¨ë“  ìœ„ì‹œ í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?')) {
            items = [];
            save();
            render();
          }
        });

        // ESC ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && $panel.classList.contains('open'))
            closePanel();
        });

        // ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', (e) => {
          if (!$panel.classList.contains('open')) return;
          const inside =
            e.target === $panel ||
            $panel.contains(e.target) ||
            e.target === $toggle;
          if (!inside) closePanel();
        });

        // íŒ¨ë„ ë‚´ë¶€ëŠ” ë²„ë¸” ë§‰ê¸° (ë‹¤ë¥¸ ì „ì—­ í´ë¦­ í•¸ë“¤ëŸ¬ì™€ ì¶©ëŒ ë°©ì§€)
        $panel.addEventListener('click', (e) => e.stopPropagation());

        // ì´ˆê¸° ë¡œë“œ
        load();
      })();

      // ===== Letter panel logic =====
      (() => {
        const KEY = 'hb_letter_v1';

        const $toggle = document.getElementById('letter-toggle');
        const $panel = document.getElementById('letter-panel');
        const $close = $panel.querySelector('.lt-close');
        const $ta = document.getElementById('letter-textarea');
        const $save = document.getElementById('letter-save');
        const $dl = document.getElementById('letter-download');
        const $clear = document.getElementById('letter-clear');
        const $meta = document.getElementById('letter-meta');

        // ìœ„ì‹œ íŒ¨ë„ì´ ì—´ë ¤ ìˆìœ¼ë©´ ë‹«ì•„ì£¼ê¸°(ê²¹ì¹¨ ë°©ì§€)
        function closeWishlistIfOpen() {
          const wlPanel = document.getElementById('wishlist-panel');
          const wlToggle = document.getElementById('wishlist-toggle');
          if (wlPanel && wlPanel.classList.contains('open')) {
            wlPanel.classList.remove('open');
            if (wlToggle) wlToggle.setAttribute('aria-expanded', 'false');
          }
        }

        // ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
        function load() {
          try {
            const raw = localStorage.getItem(KEY);
            $ta.value = raw || '';
            renderMeta('ë¶ˆëŸ¬ì˜´');
          } catch {
            $ta.value = '';
            renderMeta('');
          }
        }
        function save() {
          try {
            localStorage.setItem(KEY, $ta.value);
            renderMeta('ì €ì¥ë¨');
          } catch {
            renderMeta('ì €ì¥ ì‹¤íŒ¨');
          }
        }
        function renderMeta(text) {
          if (!text) {
            $meta.textContent = '';
            return;
          }
          const now = new Date();
          const hh = String(now.getHours()).padStart(2, '0');
          const mm = String(now.getMinutes()).padStart(2, '0');
          $meta.textContent = `${text} Â· ${hh}:${mm}`;
        }

        // ìë™ ì €ì¥(ì…ë ¥ í›„ 600ms)
        let tId;
        $ta.addEventListener('input', () => {
          clearTimeout(tId);
          tId = setTimeout(save, 600);
        });

        // ë²„íŠ¼ ì•¡ì…˜ë“¤
        $save.addEventListener('click', save);

        $dl.addEventListener('click', () => {
          const blob = new Blob([$ta.value || ''], {
            type: 'text/plain;charset=utf-8',
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          const d = new Date();
          const y = d.getFullYear(),
            m = String(d.getMonth() + 1).padStart(2, '0'),
            day = String(d.getDate()).padStart(2, '0');
          a.href = url;
          a.download = `my_letter_${y}${m}${day}.txt`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });

        $clear.addEventListener('click', () => {
          if (!confirm('í¸ì§€ ë‚´ìš©ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return;
          $ta.value = '';
          try {
            localStorage.removeItem(KEY);
          } catch {}
          renderMeta('ì‚­ì œë¨');
        });

        // ì—´ê³  ë‹«ê¸°
        function openPanel() {
          closeWishlistIfOpen();
          $panel.classList.add('open');
          $toggle.setAttribute('aria-expanded', 'true');
          setTimeout(() => $ta.focus(), 60);
        }
        function closePanel() {
          $panel.classList.remove('open');
          $toggle.setAttribute('aria-expanded', 'false');
        }
        function togglePanel() {
          if ($panel.classList.contains('open')) closePanel();
          else openPanel();
        }

        $toggle.addEventListener('click', (e) => {
          e.stopPropagation();
          togglePanel();
        });
        $close.addEventListener('click', (e) => {
          e.stopPropagation();
          closePanel();
        });
        $panel.addEventListener('click', (e) => e.stopPropagation());

        // ë°”ê¹¥ í´ë¦­ ë‹«ê¸° / ESC ë‹«ê¸°
        document.addEventListener('click', (e) => {
          if ($panel.classList.contains('open')) {
            const inside =
              e.target === $panel ||
              $panel.contains(e.target) ||
              e.target === $toggle;
            if (!inside) closePanel();
          }
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && $panel.classList.contains('open'))
            closePanel();
        });

        // ì´ˆê¸°í™”
        load();
      })();

      // ===== ì˜¤ëŠ˜ì„ ê¸°ì–µí•˜ê¸° (ìŠ¤í¬ë¦°ìƒ· ì €ì¥) =====
      (() => {
        const $toggle = document.getElementById('memory-toggle');
        const $panel = document.getElementById('memory-panel');
        const $close = $panel.querySelector('.mem-close');
        const $meta = document.getElementById('mem-meta');
        const $capBtn = document.getElementById('mem-capture');

        function setMeta(text) {
          const now = new Date();
          const hh = String(now.getHours()).padStart(2, '0');
          const mm = String(now.getMinutes()).padStart(2, '0');
          $meta.textContent = `${text} Â· ${hh}:${mm}`;
        }
        function openPanel() {
          $panel.classList.add('open');
          $toggle.setAttribute('aria-expanded', 'true');
        }
        function closePanel() {
          $panel.classList.remove('open');
          $toggle.setAttribute('aria-expanded', 'false');
        }
        function togglePanel() {
          if ($panel.classList.contains('open')) closePanel();
          else openPanel();
        }

        $toggle.addEventListener('click', (e) => {
          e.stopPropagation();
          togglePanel();
        });
        $close.addEventListener('click', (e) => {
          e.stopPropagation();
          closePanel();
        });
        $panel.addEventListener('click', (e) => e.stopPropagation());
        document.addEventListener('click', (e) => {
          if ($panel.classList.contains('open')) {
            const inside =
              e.target === $panel ||
              $panel.contains(e.target) ||
              e.target === $toggle;
            if (!inside) closePanel();
          }
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && $panel.classList.contains('open'))
            closePanel();
        });

        // html2canvas ë Œë”ë§ ì‹œ ì œì™¸í•  ìš”ì†Œ
        const ignoreElements = (node) => {
          if (!(node instanceof Element)) return false;
          const id = node.id || '';
          if (/^(memory|letter|wishlist)-(panel|toggle)$/.test(id)) return true;
          if (id === 'pageFade') return true;
          if (id === 'bgm-toggle') return true;
          if (node.tagName === 'AUDIO') return true;
          return false;
        };

        function timestampName(prefix = 'memory') {
          const d = new Date();
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          const hh = String(d.getHours()).padStart(2, '0');
          const mm = String(d.getMinutes()).padStart(2, '0');
          const ss = String(d.getSeconds()).padStart(2, '0');
          return `${prefix}_${y}${m}${day}_${hh}${mm}${ss}.png`;
        }

        $capBtn.addEventListener('click', async () => {
          if (typeof html2canvas !== 'function') {
            alert(
              'ìº¡ì³ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
            );
            return;
          }

          // ìº¡ì³ ìˆœê°„, íŒ¨ë„/í† ê¸€ ìˆ¨ê¹€
          const toHide = [$panel, $toggle];
          toHide.forEach((el) => el && el.classList.add('capture-hide'));

          try {
            // ë·°í¬íŠ¸ë§Œ ì •í™•íˆ í¬ë¡­í•´ì„œ ìº¡ì³
            const canvas = await html2canvas(document.body, {
              // í™”ë©´ì— ë³´ì´ëŠ” ì˜ì—­ í¬ê¸°
              width: window.innerWidth,
              height: window.innerHeight,

              // í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë§Œí¼ ì›ë³¸ì„ ë°˜ëŒ€ë¡œ ì´ë™ì‹œì¼œ "ë³´ì´ëŠ” í™”ë©´"ì„ 0,0ì— ë†“ê¸°
              scrollX: -window.scrollX,
              scrollY: -window.scrollY,

              // í´ë¡  ìœˆë„ìš° ìì²´ë„ ë·°í¬íŠ¸ í¬ê¸°ë¡œ
              windowWidth: window.innerWidth,
              windowHeight: window.innerHeight,

              scale: window.devicePixelRatio || 2,
              useCORS: true,
              allowTaint: false,
              backgroundColor: null,
              ignoreElements,
            });

            if (canvas.toBlob) {
              canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = timestampName('today');
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                setMeta('ì´ë¯¸ì§€ ì €ì¥ë¨');
              }, 'image/png');
            } else {
              // fallback
              const url = canvas.toDataURL('image/png');
              const a = document.createElement('a');
              a.href = url;
              a.download = timestampName('today');
              document.body.appendChild(a);
              a.click();
              a.remove();
              setMeta('ì´ë¯¸ì§€ ì €ì¥ë¨');
            }
          } catch (e) {
            setMeta('ìº¡ì³ ì‹¤íŒ¨');
          } finally {
            toHide.forEach((el) => el && el.classList.remove('capture-hide'));
          }
        });
      })();

      // ===== BGM í† ê¸€ (birthdaybgm) =====
      (() => {
        const $btn = document.getElementById('bgm-toggle');
        const bgm = window.birthdaybgm; // <audio id="birthdaybgm">

        if (!$btn || !bgm) return;

        function isOn() {
          return !bgm.paused && !bgm.muted && bgm.currentTime >= 0;
        }
        function updateUI() {
          const on = isOn();
          $btn.textContent = on ? 'ğŸ”Š BGM ë„ê¸°' : 'ğŸ”‡ BGM ì¼œê¸°';
          $btn.setAttribute('aria-pressed', on ? 'true' : 'false');
        }

        $btn.addEventListener('click', async () => {
          try {
            if (bgm.paused || bgm.muted) {
              bgm.muted = false;
              await bgm.play();
            } else {
              bgm.pause();
            }
          } catch (e) {
            // ëª¨ë°”ì¼ ì •ì±… ë“±ìœ¼ë¡œ ì¬ìƒ ì‹¤íŒ¨ ì‹œ í•œ ë²ˆ ë” ë¬´ìŒ ì¬ìƒ ì‹œë„
            try {
              bgm.muted = true;
              await bgm.play();
              bgm.muted = false;
            } catch {}
          } finally {
            updateUI();
          }
        });

        // ì˜¤ë””ì˜¤ ìƒíƒœ ë³€í™”ì— ë”°ë¼ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë™ê¸°í™”
        ['play', 'pause', 'volumechange', 'ended'].forEach((ev) =>
          bgm.addEventListener(ev, updateUI)
        );

        updateUI();
      })();
    </script>
  </body>
</html>
